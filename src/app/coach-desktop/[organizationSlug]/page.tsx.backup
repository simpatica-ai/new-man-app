'use client'

import { useState, useEffect, useCallback } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { supabase } from '@/lib/supabaseClient';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertTitle } from "@/components/ui/alert";
import { 
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Send, AlertCircle, MessageCircle, Users, ChevronDown, HelpCircle, BookOpen } from 'lucide-react';
import AppHeader from '@/components/AppHeader';
import Footer from '@/components/Footer';

import ProgressLegend from '@/components/dashboard/ProgressLegend';
import DOMPurify from 'dompurify';
import Link from 'next/link';

// --- Type Definitions ---
type PractitionerProfile = {
  id: string;
  full_name: string | null;
  last_activity?: string | null;
};

type SharedMemo = {
  virtue_id: number;
  stage_number: number;
  memo_text: string | null;
  practitioner_updated_at: string;
  sponsor_read_at: string | null;
};

type Virtue = {
  id: number;
  name: string;
};

type ChatMessage = { 
  id: number; 
  sender_id: string; 
  message_text: string; 
  created_at: string; 
  sender_name: string | null 
};

type SelectedMemo = SharedMemo & { virtue_name: string };

export default function CoachDesktop() {
  const [loading, setLoading] = useState(true);
  const [practitioners, setPractitioners] = useState<PractitionerProfile[]>([]);
  const [selectedPractitioner, setSelectedPractitioner] = useState<PractitionerProfile | null>(null);
  const [virtues, setVirtues] = useState<Virtue[]>([]);
  const [sharedMemos, setSharedMemos] = useState<SharedMemo[]>([]);
  const [selectedMemo, setSelectedMemo] = useState<SelectedMemo | null>(null);
  const [chatMessages, setChatMessages] = useState<ChatMessage[]>([]);
  const [newChatMessage, setNewChatMessage] = useState('');
  const [connectionId, setConnectionId] = useState<number | null>(null);
  const [currentUserId, setCurrentUserId] = useState<string | undefined>();
  const [unreadCount, setUnreadCount] = useState(0);


  const params = useParams();
  const router = useRouter();
  const organizationSlug = params.organizationSlug as string;

  useEffect(() => {
    document.title = "Coach Desktop";
    console.log('ðŸš€ Coach Desktop component mounted');
    console.log('Organization slug:', organizationSlug);
  }, [organizationSlug]);

  // Effect to handle localStorage after component mounts
  useEffect(() => {
    console.log('ðŸ’¾ localStorage effect triggered');
    console.log('Practitioners length:', practitioners.length);
    console.log('Selected practitioner:', selectedPractitioner);
    
    if (practitioners.length > 0 && !selectedPractitioner) {
      try {
        const storedPractitionerId = typeof window !== 'undefined' ? localStorage.getItem('selectedPractitionerId') : null;
        console.log('ðŸ” Checking localStorage for practitioner:', storedPractitionerId);
        
        if (storedPractitionerId) {
          const storedPractitioner = practitioners.find(p => p.id === storedPractitionerId);
          if (storedPractitioner) {
            console.log('Found and selecting stored practitioner:', storedPractitioner);
            setSelectedPractitioner(storedPractitioner);
          } else {
            console.log('Stored practitioner not found, selecting first:', practitioners[0]);
            setSelectedPractitioner(practitioners[0]);
          }
        } else {
          console.log('No stored practitioner, selecting first:', practitioners[0]);
          setSelectedPractitioner(practitioners[0]);
        }
      } catch (error) {
        console.error('Error accessing localStorage:', error);
        if (practitioners.length > 0) {
          setSelectedPractitioner(practitioners[0]);
        }
      }
    }
  }, [practitioners, selectedPractitioner]);

  const loadPractitioners = useCallback(async () => {
    console.log('ðŸ“‹ loadPractitioners called with organizationSlug:', organizationSlug);
    if (!organizationSlug) {
      console.log('âŒ No organization slug, returning');
      return;
    }

    try {
      setLoading(true);
      console.log('ðŸ” Getting user...');
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        console.log('âŒ No user found, redirecting to home');
        router.push('/');
        return;
      }
      console.log('âœ… User found:', user.id);
      setCurrentUserId(user.id);

      // Verify organization access
      console.log('ðŸ¢ Checking organization access for slug:', organizationSlug);
      const { data: orgData, error: orgError } = await supabase
        .from('organizations')
        .select('id')
        .eq('slug', organizationSlug)
        .single();

      if (orgError || !orgData) {
        console.error('âŒ Organization not found:', orgError);
        router.push('/');
        return;
      }
      console.log('âœ… Organization found:', orgData);

      // Get practitioners in this organization (temporary - should use assignments later)
      console.log('ðŸ‘¥ Fetching all practitioners in organization:', orgData.id);
      const { data: profiles, error: profilesError } = await supabase
        .from('profiles')
        .select('id, full_name, last_activity')
        .eq('organization_id', orgData.id)
        .contains('roles', ['org-practitioner']);

      if (profilesError) {
        console.error('âŒ Error fetching profiles:', profilesError);
        return;
      }
      console.log('ðŸ‘¤ Profiles fetched:', profiles);

      const practitionerList = profiles?.map(profile => ({
        id: profile.id,
        full_name: profile.full_name,
        last_activity: profile.last_activity
      })) || [];

      console.log('âœ… Loaded practitioners:', practitionerList);
      console.log('ðŸ“Š Practitioners count:', practitionerList.length);
      setPractitioners(practitionerList);

    } catch (error) {
      console.error("âŒ Error loading practitioners:", error);
    } finally {
      console.log('ðŸ loadPractitioners finished, setting loading to false');
      setLoading(false);
    }
  }, [organizationSlug, router, selectedPractitioner]);

  const loadPractitionerData = useCallback(async (practitioner: PractitionerProfile) => {
    console.log('ðŸ“Š loadPractitionerData called for:', practitioner?.full_name);
    console.log('Current user ID:', currentUserId);
    
    if (!practitioner || !currentUserId) {
      console.log('âŒ Missing practitioner or currentUserId');
      return;
    }

    try {
      const virtuesPromise = supabase.from('virtues').select('id, name').order('id');
      const memosPromise = supabase.from('sponsor_visible_memos').select('*').eq('user_id', practitioner.id);
      const connectionPromise = supabase.from('sponsor_connections').select('id').eq('practitioner_user_id', practitioner.id).eq('sponsor_user_id', currentUserId).eq('status', 'active').single();

      const [virtuesResult, memosResult, connectionResult] = await Promise.all([
        virtuesPromise, memosPromise, connectionPromise
      ]);

      if (virtuesResult.error) throw virtuesResult.error;
      const baseVirtues = virtuesResult.data || [];

      if (memosResult.error) throw memosResult.error;
      const memos = memosResult.data || [];
      setSharedMemos(memos);
      
      // Count unread memos
      const unread = memos.filter(m => !m.sponsor_read_at || new Date(m.practitioner_updated_at) > new Date(m.sponsor_read_at)).length;
      setUnreadCount(unread);
      
      setVirtues(baseVirtues);

      if (connectionResult.error) throw connectionResult.error;
      if (connectionResult.data) {
        const connId = connectionResult.data.id;
        setConnectionId(connId);

        const { data: rawMessages, error: messagesError } = await supabase.from('sponsor_chat_messages').select('id, sender_id, message_text, created_at, read_at').eq('connection_id', connId).order('created_at', { ascending: true });
        if (messagesError) throw messagesError;

        if (rawMessages && rawMessages.length > 0) {
          const senderIds = [...new Set(rawMessages.map(msg => msg.sender_id))];
          const { data: profiles, error: profilesError } = await supabase.from('profiles').select('id, full_name').in('id', senderIds);
          if (profilesError) throw profilesError;

          const profileMap = new Map(profiles.map(p => [p.id, p.full_name]));
          const combinedMessages = rawMessages.map(msg => ({ ...msg, sender_name: profileMap.get(msg.sender_id) || 'Unknown User' }));
          setChatMessages(combinedMessages);
        } else {
          setChatMessages([]);
        }
      }

    } catch (error) {
      console.error("Error loading practitioner data:", error);
    }
  }, [currentUserId]);

  useEffect(() => {
    loadPractitioners();
  }, [loadPractitioners]);

  useEffect(() => {
    console.log('ðŸŽ¯ selectedPractitioner effect triggered:', selectedPractitioner?.full_name);
    if (selectedPractitioner) {
      loadPractitionerData(selectedPractitioner);
    }
  }, [selectedPractitioner, loadPractitionerData]);

  const handleSelectMemo = (virtue: Virtue, stageNumber: number) => {
    const memo = sharedMemos.find(m => m.virtue_id === virtue.id && m.stage_number === stageNumber);
    if (memo) {
      setSelectedMemo({ ...memo, virtue_name: virtue.name });
      if (!memo.sponsor_read_at) {
        markMemoAsRead(memo);
      }
    } else {
        setSelectedMemo(null);
    }
  };

  const markMemoAsRead = async (memo: SharedMemo) => {
    if (!selectedPractitioner) return;

    const { error } = await supabase
      .from('sponsor_visible_memos')
      .update({ sponsor_read_at: new Date().toISOString() })
      .eq('user_id', selectedPractitioner.id)
      .eq('virtue_id', memo.virtue_id)
      .eq('stage_number', memo.stage_number);

    if (error) {
        console.error("Error marking memo as read:", error);
    } else {
        setSharedMemos(memos => memos.map(m => 
            (m.virtue_id === memo.virtue_id && m.stage_number === memo.stage_number)
            ? { ...m, sponsor_read_at: new Date().toISOString() } 
            : m
        ));
        setUnreadCount(prev => Math.max(0, prev - 1));
    }
  };

  const getStatusClasses = (virtue: Virtue) => {
    // This mimics the Dashboard's getStatusClasses function
    // For coaching, we'll show different states based on memo availability and read status
    const hasUnreadMemos = sharedMemos.some(m => 
      m.virtue_id === virtue.id && 
      (!m.sponsor_read_at || new Date(m.practitioner_updated_at) > new Date(m.sponsor_read_at))
    );
    
    const hasMemos = sharedMemos.some(m => m.virtue_id === virtue.id);
    
    if (hasUnreadMemos) {
      return 'border-green-500 bg-green-50/60';
    } else if (hasMemos) {
      return 'border-amber-500 bg-amber-50/60';
    } else {
      return 'border-stone-300 bg-stone-50/60';
    }
  };



  const handleSendChatMessage = async () => {
    if (!newChatMessage.trim() || !currentUserId || !connectionId || !selectedPractitioner) return;

    const { data: newMessage, error } = await supabase
      .from('sponsor_chat_messages')
      .insert({ connection_id: connectionId, sender_id: currentUserId, receiver_id: selectedPractitioner.id, message_text: newChatMessage } as any)
      .select('id, sender_id, message_text, created_at, read_at')
      .single();

    if (error) {
      alert("Error sending message: " + error.message);
    } else {
      if (newMessage) {
        const { data: { user } } = await supabase.auth.getUser();
        const senderName = user?.user_metadata.full_name || 'You';
        setChatMessages([...chatMessages, { ...newMessage, sender_name: senderName }]);
      }
      setNewChatMessage("");
    }
  };

  const formatLastActivity = (lastActivity?: string | null) => {
    if (!lastActivity) return 'Never';
    const days = Math.floor((Date.now() - new Date(lastActivity).getTime()) / (1000 * 60 * 60 * 24));
    if (days === 0) return 'Today';
    if (days === 1) return 'Yesterday';
    if (days <= 7) return `${days} days ago`;
    return new Date(lastActivity).toLocaleDateString();
  };
  
  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-amber-50 via-stone-50 to-amber-100 relative">
        <div className="absolute inset-0 opacity-20">
          <div className="absolute inset-0 bg-[radial-gradient(circle_at_1px_1px,_rgb(120,113,108)_1px,_transparent_0)] bg-[length:32px_32px]"></div>
        </div>
        <div className="relative z-10">
          <AppHeader />
          <main className="container mx-auto p-8">
            <div className="text-center">
              <div className="animate-pulse space-y-4">
                <div className="h-8 bg-stone-300/60 rounded-lg w-64 mx-auto"></div>
                <div className="h-4 bg-amber-200/60 rounded-lg w-48 mx-auto"></div>
              </div>
              <p className="text-stone-600 font-light mt-4">Loading coach desktop...</p>
            </div>
          </main>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-amber-50 via-stone-50 to-amber-100 relative">
      <div className="absolute inset-0 opacity-20">
        <div className="absolute inset-0 bg-[radial-gradient(circle_at_1px_1px,_rgb(120,113,108)_1px,_transparent_0)] bg-[length:32px_32px]"></div>
      </div>
      
      <div className="absolute inset-0 bg-gradient-to-b from-transparent via-amber-50/60 to-stone-100/80"></div>
      
      <div className="relative z-10">
        <AppHeader />
        <main className="container mx-auto p-8">
          <div className="mb-6">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-light text-stone-800 leading-tight">
                  Coach Desktop
                </h1>
                <p className="text-stone-600">
                  {selectedPractitioner ? `Coaching ${selectedPractitioner.full_name || 'Practitioner'} on their virtue journey` : 'Select a practitioner to begin coaching'}
                </p>
              </div>
              {practitioners.length > 1 && selectedPractitioner && (
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="outline" className="border-amber-300 text-amber-700 hover:bg-amber-50">
                      <Users className="h-4 w-4 mr-2" />
                      {selectedPractitioner.full_name || 'Practitioner'}
                      <ChevronDown className="h-4 w-4 ml-2" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end" className="w-56">
                    {practitioners.map(practitioner => (
                      <DropdownMenuItem
                        key={practitioner.id}
                        onClick={() => {
                          setSelectedPractitioner(practitioner);
                          try {
                            if (typeof window !== 'undefined') {
                              localStorage.setItem('selectedPractitionerId', practitioner.id);
                              localStorage.setItem('selectedPractitionerName', practitioner.full_name || 'Practitioner');
                            }
                          } catch (error) {
                            console.error('Error saving to localStorage:', error);
                          }
                        }}
                        className={selectedPractitioner?.id === practitioner.id ? 'bg-amber-50' : ''}
                      >
                        <div className="flex flex-col">
                          <span className="font-medium">{practitioner.full_name || 'Unnamed'}</span>
                          <span className="text-xs text-stone-500">
                            {formatLastActivity(practitioner.last_activity)}
                          </span>
                        </div>
                      </DropdownMenuItem>
                    ))}
                  </DropdownMenuContent>
                </DropdownMenu>
              )}
            </div>
          </div>

          {selectedPractitioner ? (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              {/* Left Panel: Summary + Virtue Progress */}
              <div className="lg:col-span-2 space-y-4">
                {/* Practitioner Summary Card */}
                <Card className="bg-white/80 backdrop-blur-sm border-stone-200/60 shadow-gentle border-l-4 border-l-amber-500">
                  <CardContent className="p-6">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-4">
                        <div className="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                          <Users className="h-6 w-6 text-amber-700" />
                        </div>
                        <div>
                          <h3 className="text-xl font-semibold text-stone-800">
                            {selectedPractitioner.full_name || 'Practitioner'}
                          </h3>
                          <p className="text-stone-600">Journey Progress</p>
                          {/* Progress Bar */}
                          <div className="mt-2 w-48">
                            <div className="flex justify-between text-xs text-stone-600 mb-1">
                              <span>Progress</span>
                              <span>33%</span>
                            </div>
                            <div className="w-full bg-stone-200 rounded-full h-2">
                              <div className="bg-amber-500 h-2 rounded-full" style={{ width: '33%' }}></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div className="text-right">
                        <Badge variant="secondary" className="mb-2">
                          Active
                        </Badge>
                        <div className="text-sm text-stone-600">Virtue 5</div>
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-3 gap-6 mt-4 pt-4 border-t border-stone-200">
                      <div className="text-center">
                        <div className="text-xs text-stone-600 mb-1">Last Active</div>
                        <div className="font-medium text-stone-800">
                          {formatLastActivity(selectedPractitioner.last_activity)}
                        </div>
                      </div>
                      <div className="text-center">
                        <div className="text-xs text-stone-600 mb-1">Member Since</div>
                        <div className="font-medium text-stone-800">
                          {new Date().toLocaleDateString()}
                        </div>
                      </div>
                      <div className="text-center">
                        <div className="text-xs text-stone-600 mb-1">Current Stage</div>
                        <div className="font-medium text-stone-800">Stage 2</div>
                      </div>
                    </div>
                  </CardContent>
                </Card>

                <div className="space-y-3 p-4 bg-white/80 backdrop-blur-sm rounded-lg border border-stone-200/60 shadow-gentle">
                  <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                    <h2 className="text-xl font-light text-stone-800">
                      {selectedPractitioner.full_name || 'Practitioner'}'s Virtue Progress
                    </h2>
                    <Button
                      variant="outline"
                      size="sm"
                      className="border-amber-200 text-amber-700 hover:bg-amber-50"
                    >
                      <HelpCircle className="h-4 w-4 mr-2" />
                      Coaching Guide
                    </Button>
                  </div>
                  <ProgressLegend />
                </div>

                <ul className="space-y-4">
                  {virtues.map((virtue) => (
                    <li key={virtue.id} className={`flex flex-col gap-3 md:gap-4 p-3 md:p-4 border rounded-lg bg-white/80 backdrop-blur-sm shadow-gentle transition-mindful hover:shadow-lg ${getStatusClasses(virtue)}`}>
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <h3 className="text-lg font-medium text-stone-800">{virtue.name}</h3>
                        </div>
                      </div>
                      
                      {/* Dashboard-style Stage Buttons */}
                      <div className="flex items-center justify-between">
                        {[
                          { stage: 1, name: 'Dismantling', color: '#A0522D' },
                          { stage: 2, name: 'Building', color: '#6B8E23' },
                          { stage: 3, name: 'Practicing', color: '#556B2F' }
                        ].map((stageInfo, index) => {
                          const memo = sharedMemos.find(m => m.virtue_id === virtue.id && m.stage_number === stageInfo.stage);
                          const hasUnread = memo && (!memo.sponsor_read_at || new Date(memo.practitioner_updated_at) > new Date(memo.sponsor_read_at));
                          const isCompleted = memo && memo.sponsor_read_at && new Date(memo.practitioner_updated_at) <= new Date(memo.sponsor_read_at);
                          
                          return (
                            <div key={stageInfo.stage} className="flex items-center flex-1">
                              <div className="flex flex-col items-center">
                                <button
                                  onClick={() => memo && handleSelectMemo(virtue, stageInfo.stage)}
                                  disabled={!memo}
                                  className={`w-10 h-10 rounded-lg border-2 flex items-center justify-center text-xs font-bold transition-all duration-300 shadow-sm ${
                                    memo 
                                      ? 'cursor-pointer hover:scale-105 hover:shadow-md active:scale-95 transform' 
                                      : 'cursor-default opacity-60'
                                  } ${
                                    isCompleted 
                                      ? 'bg-gradient-to-br from-white to-gray-50' 
                                      : hasUnread 
                                      ? 'bg-gradient-to-br from-amber-50 to-amber-100 hover:from-amber-100 hover:to-amber-200 animate-pulse' 
                                      : memo
                                      ? 'bg-gradient-to-br from-amber-50 to-amber-100 hover:from-amber-100 hover:to-amber-200'
                                      : 'bg-gradient-to-br from-white to-gray-50 hover:from-gray-50 hover:to-gray-100'
                                  }`}
                                  style={{
                                    borderColor: stageInfo.color,
                                    color: isCompleted ? stageInfo.color : 
                                           hasUnread ? '#92400E' : 
                                           memo ? '#92400E' : stageInfo.color
                                  }}
                                >
                                  {isCompleted ? (
                                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                      <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                    </svg>
                                  ) : (
                                    <span className="text-xs font-semibold">{stageInfo.stage}</span>
                                  )}
                                </button>
                                <span 
                                  className="text-xs font-medium mt-1 text-center"
                                  style={{ color: stageInfo.color }}
                                >
                                  {stageInfo.name}
                                </span>
                              </div>
                              
                              {/* Connecting Line */}
                              {index < 2 && (
                                <div className="flex-1 h-0.5 mx-2 bg-stone-300 relative">
                                  <div 
                                    className="h-full transition-all duration-500"
                                    style={{
                                      backgroundColor: isCompleted ? stageInfo.color : 'transparent',
                                      width: isCompleted ? '100%' : '0%'
                                    }}
                                  />
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </li>
                  ))}
                </ul>
              </div>
              
              {/* Right Panel: Chat, Assessment, Reports, and Memo Viewer */}
              <div className="lg:col-span-1 space-y-4">
                {/* Chat Card - Moved to top */}
                <Card className="bg-white/80 backdrop-blur-sm border-stone-200/60 shadow-gentle">
                  <CardHeader>
                    <CardTitle className="text-stone-800 font-medium flex items-center gap-2">
                      <MessageCircle className="h-5 w-5 text-amber-700" />
                      Chat with {selectedPractitioner.full_name || 'Practitioner'}
                      {unreadCount > 0 && (
                        <Badge className="bg-green-500 text-white text-xs ml-2">
                          {unreadCount} unread
                        </Badge>
                      )}
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div className="space-y-4 max-h-[300px] overflow-y-auto pr-2 border border-stone-200/60 p-4 rounded-lg bg-white/40 backdrop-blur-sm flex flex-col shadow-inner">
                      {chatMessages.length > 0 ? chatMessages.map(message => (
                        <div key={message.id} className={`p-3 rounded-lg shadow-gentle flex flex-col transition-all duration-200 ${ 
                            message.sender_id === currentUserId 
                                ? 'bg-amber-500 text-white self-end' 
                                : 'bg-white/80 backdrop-blur-sm text-stone-800 self-start border border-stone-200/60' 
                        } max-w-[85%]`}>
                            <p className={`text-xs mb-1 ${ message.sender_id === currentUserId ? 'text-amber-100' : 'text-stone-500' }`}>
                            <strong>{message.sender_name || 'Unknown'}</strong> - {new Date(message.created_at).toLocaleTimeString()}
                            </p>
                            <p className="whitespace-pre-wrap leading-relaxed text-sm">{message.message_text}</p>
                        </div>
                      )) : (
                        <Alert className="border-amber-200 bg-amber-50/60 backdrop-blur-sm">
                            <AlertCircle className="h-4 w-4 text-amber-600" />
                            <AlertTitle className="text-amber-800">No Messages Yet</AlertTitle>
                        </Alert>
                      )}
                    </div>
                    <div className="flex items-end gap-2">
                        <Textarea 
                            className="flex-grow bg-white/60 backdrop-blur-sm border-stone-300 resize-none transition-all duration-200 focus:bg-white/80 text-sm" 
                            placeholder="Type your message..." 
                            value={newChatMessage} 
                            onChange={(e) => setNewChatMessage(e.target.value)} 
                            onKeyDown={(e) => { 
                                if (e.key === 'Enter' && !e.shiftKey) { 
                                    e.preventDefault(); 
                                    handleSendChatMessage(); 
                                }
                            }} 
                            rows={2}
                        />
                        <Button 
                            onClick={handleSendChatMessage} 
                            size="icon" 
                            className="flex-shrink-0 bg-amber-600 hover:bg-amber-700 text-white shadow-md h-10 w-10 transition-all duration-200"
                        >
                            <Send size={16} />
                        </Button>
                    </div>
                  </CardContent>
                </Card>

                {/* Assessment Card */}
                <Card className="bg-white/80 backdrop-blur-sm border-stone-200/60 shadow-gentle">
                  <CardHeader className="flex flex-row items-center gap-4 space-y-0 pb-2">
                    <BookOpen className="h-8 w-8 text-amber-700" />
                    <div>
                      <CardTitle className="text-stone-800 font-medium">Assessment</CardTitle>
                    </div>
                  </CardHeader>
                  <CardContent>
                    {virtues.length > 0 ? (
                      <>
                        <p className="text-sm text-stone-600 text-center mb-4">
                          Virtue assessment completed. View the detailed results and growth plan.
                        </p>
                        <div className="text-center">
                          <Link href="/assessment">
                            <Button size="sm" variant="outline" className="border-amber-200 text-amber-700 hover:bg-amber-50">
                              View Assessment Results
                            </Button>
                          </Link>
                        </div>
                      </>
                    ) : (
                      <div>
                        <div className="flex items-center gap-2 mb-3 text-amber-700">
                          <AlertCircle size={18} />
                          <p className="text-sm font-medium">Assessment Incomplete</p>
                        </div>
                        <p className="text-sm text-stone-600 mb-3">
                          This practitioner has not completed their virtue assessment yet.
                        </p>
                        <div className="text-center">
                          <Link href="/assessment">
                            <Button size="sm" variant="outline" className="border-amber-200 text-amber-700 hover:bg-amber-50">
                              View Assessment
                            </Button>
                          </Link>
                        </div>
                      </div>
                    )}
                  </CardContent>
                </Card>

                {/* Reports Card */}
                <Card className="bg-white/80 backdrop-blur-sm border-stone-200/60 shadow-gentle">
                  <CardHeader className="flex flex-row items-center gap-4 space-y-0 pb-2">
                    <HelpCircle className="h-8 w-8 text-amber-700" />
                    <div>
                      <CardTitle className="text-stone-800 font-medium">Reports</CardTitle>
                    </div>
                  </CardHeader>
                  <CardContent>
                    <p className="text-sm text-stone-600 mb-3">
                      Generate detailed progress reports for this practitioner.
                    </p>
                    <div className="space-y-2">
                      <Link href={`/reports/work-product?practitioner_id=${selectedPractitioner.id}`}>
                        <Button size="sm" variant="outline" className="w-full border-amber-200 text-amber-700 hover:bg-amber-50">
                          Work Product Report
                        </Button>
                      </Link>
                      <Link href={`/reports/progress?practitioner_id=${selectedPractitioner.id}`}>
                        <Button size="sm" variant="outline" className="w-full border-amber-200 text-amber-700 hover:bg-amber-50">
                          Progress Report
                        </Button>
                      </Link>
                    </div>
                  </CardContent>
                </Card>       {/* Right Panel: Chat, Assessment, Reports, and Memo Viewer */}
              <div className="lg:col-span-1 space-y-4">
                {/* Chat Card - Moved to top */}
                <Card className="bg-white/80 backdrop-blur-sm border-stone-200/60 shadow-gentle">
                  <CardHeader>
                    <CardTitle className="text-stone-800 font-medium flex items-center gap-2">
                      <MessageCircle className="h-5 w-5 text-amber-700" />
                      Chat with {selectedPractitioner.full_name || 'Practitioner'}
                      {unreadCount > 0 && (
                        <Badge className="bg-green-500 text-white text-xs ml-2">
                          {unreadCount} unread
                        </Badge>
                      )}
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div className="space-y-4 max-h-[300px] overflow-y-auto pr-2 border border-stone-200/60 p-4 rounded-lg bg-white/40 backdrop-blur-sm flex flex-col shadow-inner">
                      {chatMessages.length > 0 ? chatMessages.map(message => (
                        <div key={message.id} className={`p-3 rounded-lg shadow-gentle flex flex-col transition-all duration-200 ${ 
                            message.sender_id === currentUserId 
                                ? 'bg-amber-500 text-white self-end' 
                                : 'bg-white/80 backdrop-blur-sm text-stone-800 self-start border border-stone-200/60' 
                        } max-w-[85%]`}>
                            <p className={`text-xs mb-1 ${ message.sender_id === currentUserId ? 'text-amber-100' : 'text-stone-500' }`}>
                            <strong>{message.sender_name || 'Unknown'}</strong> - {new Date(message.created_at).toLocaleTimeString()}
                            </p>
                            <p className="whitespace-pre-wrap leading-relaxed text-sm">{message.message_text}</p>
                        </div>
                      )) : (
                        <Alert className="border-amber-200 bg-amber-50/60 backdrop-blur-sm">
                            <AlertCircle className="h-4 w-4 text-amber-600" />
                            <AlertTitle className="text-amber-800">No Messages Yet</AlertTitle>
                        </Alert>
                      )}
                    </div>
                    <div className="flex items-end gap-2">
                        <Textarea 
                            className="flex-grow bg-white/60 backdrop-blur-sm border-stone-300 resize-none transition-all duration-200 focus:bg-white/80 text-sm" 
                            placeholder="Type your message..." 
                            value={newChatMessage} 
                            onChange={(e) => setNewChatMessage(e.target.value)} 
                            onKeyDown={(e) => { 
                                if (e.key === 'Enter' && !e.shiftKey) { 
                                    e.preventDefault(); 
                                    handleSendChatMessage(); 
                                }
                            }} 
                            rows={2}
                        />
                        <Button 
                            onClick={handleSendChatMessage} 
                            size="icon" 
                            className="flex-shrink-0 bg-amber-600 hover:bg-amber-700 text-white shadow-md h-10 w-10 transition-all duration-200"
                        >
                            <Send size={16} />
                        </Button>
                    </div>
                  </CardContent>
                </Card>

                {/* Assessment Card */}
                <Card className="bg-white/80 backdrop-blur-sm border-stone-200/60 shadow-gentle">
                  <CardHeader className="flex flex-row items-center gap-4 space-y-0 pb-2">
                    <BookOpen className="h-8 w-8 text-amber-700" />
                    <div>
                      <CardTitle className="text-stone-800 font-medium">Assessment</CardTitle>
                    </div>
                  </CardHeader>
                  <CardContent>
                    {virtues.length > 0 ? (
                      <>
                        <p className="text-sm text-stone-600 text-center mb-4">
                          Virtue assessment completed. View the detailed results and growth plan.
                        </p>
                        <div className="text-center">
                          <Link href="/assessment">
                            <Button size="sm" variant="outline" className="border-amber-200 text-amber-700 hover:bg-amber-50">
                              View Assessment Results
                            </Button>
                          </Link>
                        </div>
                      </>
                    ) : (
                      <div>
                        <div className="flex items-center gap-2 mb-3 text-amber-700">
                          <AlertCircle size={18} />
                          <p className="text-sm font-medium">Assessment Incomplete</p>
                        </div>
                        <p className="text-sm text-stone-600 mb-3">
                          This practitioner has not completed their virtue assessment yet.
                        </p>
                        <div className="text-center">
                          <Link href="/assessment">
                            <Button size="sm" variant="outline" className="border-amber-200 text-amber-700 hover:bg-amber-50">
                              View Assessment
                            </Button>
                          </Link>
                        </div>
                      </div>
                    )}
                  </CardContent>
                </Card>

                {/* Reports Card */}
                <Card className="bg-white/80 backdrop-blur-sm border-stone-200/60 shadow-gentle">
                  <CardHeader className="flex flex-row items-center gap-4 space-y-0 pb-2">
                    <HelpCircle className="h-8 w-8 text-amber-700" />
                    <div>
                      <CardTitle className="text-stone-800 font-medium">Reports</CardTitle>
                    </div>
                  </CardHeader>
                  <CardContent>
                    <p className="text-sm text-stone-600 mb-3">
                      Generate detailed progress reports for this practitioner.
                    </p>
                    <div className="space-y-2">
                      <Link href={`/reports/work-product?practitioner_id=${selectedPractitioner.id}`}>
                        <Button size="sm" variant="outline" className="w-full border-amber-200 text-amber-700 hover:bg-amber-50">
                          Work Product Report
                        </Button>
                      </Link>
                      <Link href={`/reports/progress?practitioner_id=${selectedPractitioner.id}`}>
                        <Button size="sm" variant="outline" className="w-full border-amber-200 text-amber-700 hover:bg-amber-50">
                          Progress Report
                        </Button>
                      </Link>
                    </div>
                  </CardContent>
                </Card>

                {/* Selected Memo Display */}
                {selectedMemo && (
                  <Card className="bg-white/80 backdrop-blur-sm border-stone-200/60 shadow-gentle">
                    <CardHeader>
                      <CardTitle className="text-stone-800 font-medium text-sm">
                        {selectedMemo.virtue_name} - Stage {selectedMemo.stage_number}
                      </CardTitle>
                      <CardDescription className="text-stone-600 text-xs">
                        Last updated: {new Date(selectedMemo.practitioner_updated_at).toLocaleString()}
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      <div 
                        className="prose prose-sm max-w-none p-3 bg-white/60 backdrop-blur-sm rounded-lg border border-stone-200/60" 
                        dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(selectedMemo.memo_text || '<em>No content shared.</em>') }} 
                      />
                    </CardContent>
                  </Card>
                )}
              </div>
            </div>
          ) : (
            <Card className="bg-white/80 backdrop-blur-sm border-stone-200/60 shadow-gentle">
              <CardContent className="flex items-center justify-center h-96">
                <div className="text-center">
                  <Users className="h-12 w-12 text-stone-400 mx-auto mb-4" />
                  <p className="text-stone-600 font-light">
                    {practitioners.length === 0 
                      ? 'No practitioners assigned to you' 
                      : 'Select a practitioner to begin coaching'
                    }
                  </p>
                </div>
              </CardContent>
            </Card>
          )}
        </main>
        
        <Footer />
      </div>
    </div>
  );
}